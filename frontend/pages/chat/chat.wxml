<!--pages/chat/chat.wxml-->
<view class="chat-container">
  <!-- 聊天内容区域 -->
  <scroll-view 
    class="chat-content" 
    scroll-y 
    scroll-top="{{scrollTop}}"
    scroll-into-view="{{scrollIntoView}}"
  >
    <!-- 消息列表 -->
    <view class="message-list">
      <view 
        class="message-item {{message.type}}" 
        wx:for="{{messages}}" 
        wx:key="id"
        wx:for-item="message"
        id="msg-{{message.id}}"
      >
        <!-- 场景介绍 -->
        <!-- 已移至system-message统一处理 -->

        <!-- 时间记录消息 -->
        <!-- 已移至system-message统一处理 -->

        <!-- AI消息显示头像 -->
        <view class="message-avatar" wx:if="{{message.type == 'ai'}}">
          <image class="avatar-img" src="{{message.avatar || '/assets/user/role2.jpg'}}" mode="aspectFill"></image>
        </view>
        
        <!-- 消息内容 -->
        <view class="message-content" wx:if="{{message.type == 'ai' || message.type == 'user'}}">
          <!-- 特殊标记 -->
          <view class="message-tags" wx:if="{{message.isHighEnergy || message.autoGenerated}}">
            <text class="tag high-energy" wx:if="{{message.isHighEnergy}}">高能女主</text>
            <text class="tag auto-gen" wx:if="{{message.autoGenerated}}">AI演示</text>
          </view>
          
          <text class="message-text">{{message.content}}</text>
          <!-- 打字机效果光标 -->
          <text class="typing-cursor" wx:if="{{message.isTyping}}">|</text>
          
          <!-- 选择影响提示 -->
          <view class="choice-impact" wx:if="{{message.choiceImpact}}">
            <text class="impact-text">{{message.choiceImpact}}</text>
          </view>
        </view>
        
        <!-- 用户消息显示头像 -->
        <view class="message-avatar" wx:if="{{message.type == 'user'}}">
          <image class="avatar-img {{message.isEmpowered ? 'empowered' : ''}} {{message.isHighEnergy ? 'high-energy' : ''}}" src="{{message.avatar || '/assets/user/role1.jpg'}}" mode="aspectFill"></image>
        </view>

        <!-- 高能女主工具消息 -->
        <view class="high-energy-container" wx:if="{{message.type == 'high_energy' || message.type == 'high_energy_activation' || message.type == 'high_energy_ai' || message.type == 'high_energy_user' || message.type == 'high_energy_end'}}">
          <view class="energy-header">
            <text class="energy-title" wx:if="{{message.type == 'high_energy'}}">⚡ 高能女主工具已激活</text>
            <text class="energy-title" wx:if="{{message.type == 'high_energy_activation'}}">🔥 变身高能模式</text>
            <text class="energy-title" wx:if="{{message.type == 'high_energy_ai'}}">⚡ 高能导师 第{{message.round}}轮</text>
            <text class="energy-title" wx:if="{{message.type == 'high_energy_user'}}">💪 觉醒中的你 第{{message.round}}轮</text>
            <text class="energy-title" wx:if="{{message.type == 'high_energy_end'}}">✨ 高能模式完成</text>
          </view>
          <view class="energy-content">
            <text class="energy-text">{{message.content}}</text>
          </view>
        </view>

        <!-- 内心独白消息 -->
        <view class="inner-monologue-container" wx:if="{{message.type == 'inner_monologue'}}">
          <view class="monologue-header">
            <text class="monologue-title">💭 TA的内心独白</text>
          </view>
          <view class="monologue-content">
            <text class="monologue-text">{{message.content}}</text>
          </view>
        </view>

        <!-- 关系分析消息 -->
        <view class="relationship-analysis-container" wx:if="{{message.type == 'relationship_analysis'}}">
          <view class="analysis-header">
            <text class="analysis-title">📋 关系分析报告</text>
          </view>
          <view class="analysis-content">
            <text class="analysis-text">{{message.content}}</text>
          </view>
        </view>

        <!-- 系统提示信息统一格式 -->
        <view class="system-message" wx:if="{{message.type == 'scene_intro' || message.type == 'time_record' || message.type == 'system_prompt' || message.type == 'system' || message.type == 'system_unified'}}">
          <text class="system-text">{{message.content}}</text>
          <button wx:if="{{message.showContinueButton}}" class="continue-btn" bindtap="continueConversation">继续</button>
        </view>

        <!-- 系统剧情介绍 -->
        <view class="system-narrative" wx:if="{{message.type == 'system_narrative'}}">
          <text class="narrative-text">{{message.content}}</text>
        </view>
      </view>
      
      <!-- 选择卡 -->
      <view class="choices-container" wx:if="{{showChoices && choices.length > 0}}">
        <view class="choices-prompt">{{choicesPrompt || '你会怎么回应？'}}</view>
        <view class="choices-list">
          <view 
            class="choice-item {{choicesEnabled ? '' : 'disabled'}}" 
            wx:for="{{choices}}" 
            wx:key="id"
            data-choice="{{item}}"
            data-index="{{index}}"
            bindtap="handleChoiceSelect"
          >
            <view class="choice-content">
              <view class="choice-text">{{item.title || item.text}}</view>
              <view class="choice-meta">
                <view class="choice-impact">{{item.potentialImpact || item.impact}}</view>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- 自由输入提示 -->
      <view class="free-input-prompt" wx:if="{{showInput && inputPrompt}}">
        <text>{{inputPrompt}}</text>
      </view>

      <!-- 场景切换提示 -->
      <view class="scene-switch-container" wx:if="{{sceneSwitchData}}">
        <view class="scene-switch-card">
          <view class="switch-header">
            <text class="switch-title">🎬 场景切换</text>
          </view>
          <view class="switch-content">
            <text class="switch-text">{{sceneSwitchData.prompt}}</text>
          </view>
          <view class="switch-actions">
            <button class="switch-btn continue" bindtap="continueToNextScene">继续对话</button>
            <button class="switch-btn restart" bindtap="restartCurrentScene">重新开始</button>
          </view>
        </view>
      </view>

      <!-- 加载状态 -->
      <view class="loading-message" wx:if="{{isLoading}}">
        <view class="typing-indicator">
          <view class="dot"></view>
          <view class="dot"></view>
          <view class="dot"></view>
        </view>
        <text class="loading-text">AI正在思考中...</text>
      </view>
    </view>
  </scroll-view>

  <!-- 输入区域 -->
  <view class="input-area">
    <!-- 功能按钮横滑模块 -->
    <scroll-view class="function-buttons-scroll" scroll-x enable-flex>
      <view class="function-buttons-container">
        <view class="func-button" bindtap="showSceneList">
          <view class="func-icon">🎬</view>
          <view class="func-text">场景选择</view>
        </view>
        
        <view class="func-button" bindtap="activateInnerMonologue">
          <view class="func-icon">🔍</view>
          <view class="func-text">对方内心独白</view>
        </view>
        
        <view class="func-button" bindtap="activateHighEnergyMode" wx:if="{{!isHighEnergyMode}}">
          <view class="func-icon">⚡️</view>
          <view class="func-text">自信模式</view>
        </view>
        
        <view class="func-button end-high-energy" bindtap="manualEndHighEnergyMode" wx:if="{{isHighEnergyMode}}">
          <view class="func-icon">❌</view>
          <view class="func-text">结束自信模式</view>
        </view>

        <view class="func-button" bindtap="activateRelationshipAnalysis">
          <view class="func-icon">📋</view>
          <view class="func-text">关系报告</view>
        </view>

        <view class="func-button clear-button" bindtap="clearChat">
          <view class="func-icon">🗑️</view>
          <view class="func-text">清除对话</view>
        </view>
      </view>
    </scroll-view>
    
    <!-- 输入框（常驻显示） -->
    <view class="input-wrapper">
      <textarea 
        class="message-input"
        placeholder="{{inputPlaceholder || '输入你的想法...'}}"
        value="{{inputValue}}"
        bindinput="onInputChange"
        bindconfirm="sendMessage"
        confirm-type="send"
        auto-height
        maxlength="{{inputMaxLength || 500}}"
        show-confirm-bar="{{false}}"
      ></textarea>
    </view>
  </view>

  <!-- 场景列表上浮层 -->
  <view class="scene-list-overlay" wx:if="{{showSceneListModal}}" bindtap="hideSceneList">
    <view class="scene-list-modal" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">🎬 场景列表</text>
        <view class="close-btn" bindtap="hideSceneList">×</view>
      </view>
      
      <view class="current-scene-info" wx:if="{{currentScene}}">
        <view class="current-scene-label">当前场景</view>
        <view class="current-scene-name">{{currentScene.name}}</view>
        <view class="current-scene-desc">{{currentScene.description}}</view>
      </view>
      
      <scroll-view class="scenes-scroll" scroll-y>
        <view class="scenes-list-modal">
          <view 
            class="scene-list-item {{item.id === currentScene.id ? 'active' : ''}}" 
            wx:for="{{scenesList}}" 
            wx:key="id"
            data-scene="{{item}}"
            data-index="{{index}}"
            bindtap="selectScene"
          >
            <view class="scene-item-header">
              <text class="scene-item-number">{{index + 1}}.</text>
              <text class="scene-item-name">{{item.name}}</text>
              <text wx:if="{{item.id === currentScene.id}}" class="current-scene-badge">进行中</text>
              <text class="scene-item-time" wx:if="{{item.time}}">{{item.time}}</text>
            </view>
            <text class="scene-item-desc">{{item.description}}</text>
            <view class="scene-item-details" wx:if="{{item.location || item.action}}">
              <text class="scene-item-location" wx:if="{{item.location}}">📍 {{item.location}}</text>
              <text class="scene-item-action" wx:if="{{item.action}}">🎬 {{item.action}}</text>
            </view>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>
</view>

<!-- 场景进度指示器已移除 - 改为后台记录 -->