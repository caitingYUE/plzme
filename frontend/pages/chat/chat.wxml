<!--pages/chat/chat.wxml-->
<view class="chat-container">
  <!-- èŠå¤©å†…å®¹åŒºåŸŸ -->
  <scroll-view 
    class="chat-content" 
    scroll-y 
    scroll-top="{{scrollTop}}"
    scroll-into-view="{{scrollIntoView}}"
  >
    <!-- æ¶ˆæ¯åˆ—è¡¨ -->
    <view class="message-list">
      <view 
        class="message-item {{message.type}}" 
        wx:for="{{messages}}" 
        wx:key="id"
        wx:for-item="message"
        id="msg-{{message.id}}"
      >
        <!-- åœºæ™¯ä»‹ç» -->
        <!-- å·²ç§»è‡³system-messageç»Ÿä¸€å¤„ç† -->

        <!-- æ—¶é—´è®°å½•æ¶ˆæ¯ -->
        <!-- å·²ç§»è‡³system-messageç»Ÿä¸€å¤„ç† -->

        <!-- AIæ¶ˆæ¯æ˜¾ç¤ºå¤´åƒ -->
        <view class="message-avatar" wx:if="{{message.type == 'ai'}}">
          <image class="avatar-img" src="{{message.avatar || '/assets/user/role2.jpg'}}" mode="aspectFill"></image>
        </view>
        
        <!-- æ¶ˆæ¯å†…å®¹ -->
        <view class="message-content" wx:if="{{message.type == 'ai' || message.type == 'user'}}">
          <!-- ç‰¹æ®Šæ ‡è®° -->
          <view class="message-tags" wx:if="{{message.isHighEnergy || message.autoGenerated}}">
            <text class="tag high-energy" wx:if="{{message.isHighEnergy}}">é«˜èƒ½å¥³ä¸»</text>
            <text class="tag auto-gen" wx:if="{{message.autoGenerated}}">AIæ¼”ç¤º</text>
          </view>
          
          <text class="message-text">{{message.content}}</text>
          <!-- æ‰“å­—æœºæ•ˆæœå…‰æ ‡ -->
          <text class="typing-cursor" wx:if="{{message.isTyping}}">|</text>
          
          <!-- é€‰æ‹©å½±å“æç¤º -->
          <view class="choice-impact" wx:if="{{message.choiceImpact}}">
            <text class="impact-text">{{message.choiceImpact}}</text>
          </view>
        </view>
        
        <!-- ç”¨æˆ·æ¶ˆæ¯æ˜¾ç¤ºå¤´åƒ -->
        <view class="message-avatar" wx:if="{{message.type == 'user'}}">
          <image class="avatar-img {{message.isEmpowered ? 'empowered' : ''}} {{message.isHighEnergy ? 'high-energy' : ''}}" src="{{message.avatar || '/assets/user/role1.jpg'}}" mode="aspectFill"></image>
        </view>

        <!-- é«˜èƒ½å¥³ä¸»å·¥å…·æ¶ˆæ¯ -->
        <view class="high-energy-container" wx:if="{{message.type == 'high_energy' || message.type == 'high_energy_activation' || message.type == 'high_energy_ai' || message.type == 'high_energy_user' || message.type == 'high_energy_end'}}">
          <view class="energy-header">
            <text class="energy-title" wx:if="{{message.type == 'high_energy'}}">âš¡ é«˜èƒ½å¥³ä¸»å·¥å…·å·²æ¿€æ´»</text>
            <text class="energy-title" wx:if="{{message.type == 'high_energy_activation'}}">ğŸ”¥ å˜èº«é«˜èƒ½æ¨¡å¼</text>
            <text class="energy-title" wx:if="{{message.type == 'high_energy_ai'}}">âš¡ é«˜èƒ½å¯¼å¸ˆ ç¬¬{{message.round}}è½®</text>
            <text class="energy-title" wx:if="{{message.type == 'high_energy_user'}}">ğŸ’ª è§‰é†’ä¸­çš„ä½  ç¬¬{{message.round}}è½®</text>
            <text class="energy-title" wx:if="{{message.type == 'high_energy_end'}}">âœ¨ é«˜èƒ½æ¨¡å¼å®Œæˆ</text>
          </view>
          <view class="energy-content">
            <text class="energy-text">{{message.content}}</text>
          </view>
        </view>

        <!-- å†…å¿ƒç‹¬ç™½æ¶ˆæ¯ -->
        <view class="inner-monologue-container" wx:if="{{message.type == 'inner_monologue'}}">
          <view class="monologue-header">
            <text class="monologue-title">ğŸ’­ TAçš„å†…å¿ƒç‹¬ç™½</text>
          </view>
          <view class="monologue-content">
            <text class="monologue-text">{{message.content}}</text>
          </view>
        </view>

        <!-- å…³ç³»åˆ†ææ¶ˆæ¯ -->
        <view class="relationship-analysis-container" wx:if="{{message.type == 'relationship_analysis'}}">
          <view class="analysis-header">
            <text class="analysis-title">ğŸ“‹ å…³ç³»åˆ†ææŠ¥å‘Š</text>
          </view>
          <view class="analysis-content">
            <text class="analysis-text">{{message.content}}</text>
          </view>
        </view>

        <!-- ç³»ç»Ÿæç¤ºä¿¡æ¯ç»Ÿä¸€æ ¼å¼ -->
        <view class="system-message" wx:if="{{message.type == 'scene_intro' || message.type == 'time_record' || message.type == 'system_prompt' || message.type == 'system' || message.type == 'system_unified'}}">
          <text class="system-text">{{message.content}}</text>
          <button wx:if="{{message.showContinueButton}}" class="continue-btn" bindtap="continueConversation">ç»§ç»­</button>
        </view>

        <!-- ç³»ç»Ÿå‰§æƒ…ä»‹ç» -->
        <view class="system-narrative" wx:if="{{message.type == 'system_narrative'}}">
          <text class="narrative-text">{{message.content}}</text>
        </view>
      </view>
      
      <!-- é€‰æ‹©å¡ -->
      <view class="choices-container" wx:if="{{showChoices && choices.length > 0}}">
        <view class="choices-prompt">{{choicesPrompt || 'ä½ ä¼šæ€ä¹ˆå›åº”ï¼Ÿ'}}</view>
        <view class="choices-list">
          <view 
            class="choice-item {{choicesEnabled ? '' : 'disabled'}}" 
            wx:for="{{choices}}" 
            wx:key="id"
            data-choice="{{item}}"
            data-index="{{index}}"
            bindtap="handleChoiceSelect"
          >
            <view class="choice-content">
              <view class="choice-text">{{item.title || item.text}}</view>
              <view class="choice-meta">
                <view class="choice-impact">{{item.potentialImpact || item.impact}}</view>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- è‡ªç”±è¾“å…¥æç¤º -->
      <view class="free-input-prompt" wx:if="{{showInput && inputPrompt}}">
        <text>{{inputPrompt}}</text>
      </view>

      <!-- åœºæ™¯åˆ‡æ¢æç¤º -->
      <view class="scene-switch-container" wx:if="{{sceneSwitchData}}">
        <view class="scene-switch-card">
          <view class="switch-header">
            <text class="switch-title">ğŸ¬ åœºæ™¯åˆ‡æ¢</text>
          </view>
          <view class="switch-content">
            <text class="switch-text">{{sceneSwitchData.prompt}}</text>
          </view>
          <view class="switch-actions">
            <button class="switch-btn continue" bindtap="continueToNextScene">ç»§ç»­å¯¹è¯</button>
            <button class="switch-btn restart" bindtap="restartCurrentScene">é‡æ–°å¼€å§‹</button>
          </view>
        </view>
      </view>

      <!-- åŠ è½½çŠ¶æ€ -->
      <view class="loading-message" wx:if="{{isLoading}}">
        <view class="typing-indicator">
          <view class="dot"></view>
          <view class="dot"></view>
          <view class="dot"></view>
        </view>
        <text class="loading-text">AIæ­£åœ¨æ€è€ƒä¸­...</text>
      </view>
    </view>
  </scroll-view>

  <!-- è¾“å…¥åŒºåŸŸ -->
  <view class="input-area">
    <!-- åŠŸèƒ½æŒ‰é’®æ¨ªæ»‘æ¨¡å— -->
    <scroll-view class="function-buttons-scroll" scroll-x enable-flex>
      <view class="function-buttons-container">
        <view class="func-button" bindtap="showSceneList">
          <view class="func-icon">ğŸ¬</view>
          <view class="func-text">åœºæ™¯é€‰æ‹©</view>
        </view>
        
        <view class="func-button" bindtap="activateInnerMonologue">
          <view class="func-icon">ğŸ”</view>
          <view class="func-text">å¯¹æ–¹å†…å¿ƒç‹¬ç™½</view>
        </view>
        
        <view class="func-button" bindtap="activateHighEnergyMode" wx:if="{{!isHighEnergyMode}}">
          <view class="func-icon">âš¡ï¸</view>
          <view class="func-text">è‡ªä¿¡æ¨¡å¼</view>
        </view>
        
        <view class="func-button end-high-energy" bindtap="manualEndHighEnergyMode" wx:if="{{isHighEnergyMode}}">
          <view class="func-icon">âŒ</view>
          <view class="func-text">ç»“æŸè‡ªä¿¡æ¨¡å¼</view>
        </view>

        <view class="func-button" bindtap="activateRelationshipAnalysis">
          <view class="func-icon">ğŸ“‹</view>
          <view class="func-text">å…³ç³»æŠ¥å‘Š</view>
        </view>

        <view class="func-button clear-button" bindtap="clearChat">
          <view class="func-icon">ğŸ—‘ï¸</view>
          <view class="func-text">æ¸…é™¤å¯¹è¯</view>
        </view>
      </view>
    </scroll-view>
    
    <!-- è¾“å…¥æ¡†ï¼ˆå¸¸é©»æ˜¾ç¤ºï¼‰ -->
    <view class="input-wrapper">
      <textarea 
        class="message-input"
        placeholder="{{inputPlaceholder || 'è¾“å…¥ä½ çš„æƒ³æ³•...'}}"
        value="{{inputValue}}"
        bindinput="onInputChange"
        bindconfirm="sendMessage"
        confirm-type="send"
        auto-height
        maxlength="{{inputMaxLength || 500}}"
        show-confirm-bar="{{false}}"
      ></textarea>
    </view>
  </view>

  <!-- åœºæ™¯åˆ—è¡¨ä¸Šæµ®å±‚ -->
  <view class="scene-list-overlay" wx:if="{{showSceneListModal}}" bindtap="hideSceneList">
    <view class="scene-list-modal" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">ğŸ¬ åœºæ™¯åˆ—è¡¨</text>
        <view class="close-btn" bindtap="hideSceneList">Ã—</view>
      </view>
      
      <view class="current-scene-info" wx:if="{{currentScene}}">
        <view class="current-scene-label">å½“å‰åœºæ™¯</view>
        <view class="current-scene-name">{{currentScene.name}}</view>
        <view class="current-scene-desc">{{currentScene.description}}</view>
      </view>
      
      <scroll-view class="scenes-scroll" scroll-y>
        <view class="scenes-list-modal">
          <view 
            class="scene-list-item {{item.id === currentScene.id ? 'active' : ''}}" 
            wx:for="{{scenesList}}" 
            wx:key="id"
            data-scene="{{item}}"
            data-index="{{index}}"
            bindtap="selectScene"
          >
            <view class="scene-item-header">
              <text class="scene-item-number">{{index + 1}}.</text>
              <text class="scene-item-name">{{item.name}}</text>
              <text wx:if="{{item.id === currentScene.id}}" class="current-scene-badge">è¿›è¡Œä¸­</text>
              <text class="scene-item-time" wx:if="{{item.time}}">{{item.time}}</text>
            </view>
            <text class="scene-item-desc">{{item.description}}</text>
            <view class="scene-item-details" wx:if="{{item.location || item.action}}">
              <text class="scene-item-location" wx:if="{{item.location}}">ğŸ“ {{item.location}}</text>
              <text class="scene-item-action" wx:if="{{item.action}}">ğŸ¬ {{item.action}}</text>
            </view>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>
</view>

<!-- åœºæ™¯è¿›åº¦æŒ‡ç¤ºå™¨å·²ç§»é™¤ - æ”¹ä¸ºåå°è®°å½• -->