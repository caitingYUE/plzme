# PlzMe å¿ƒç†å‰§æœ¬äº’åŠ¨å¹³å° - æŠ€æœ¯æ–‡æ¡£

**ç‰ˆæœ¬**: v2.0  
**åˆ›å»ºæ—¥æœŸ**: 2024å¹´12æœˆ  
**æœ€åæ›´æ–°**: 2024å¹´12æœˆ  
**ç»´æŠ¤å›¢é˜Ÿ**: æŠ€æœ¯å¼€å‘å›¢é˜Ÿ  

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 æŠ€æœ¯æ ˆ
- **å‰ç«¯æ¡†æ¶**: å¾®ä¿¡å°ç¨‹åºåŸç”Ÿæ¡†æ¶
- **ç¼–ç¨‹è¯­è¨€**: JavaScript (ES2020)
- **AIæœåŠ¡**: DeepSeek API
- **å­˜å‚¨**: å¾®ä¿¡å°ç¨‹åºæœ¬åœ°å­˜å‚¨ + å¤šçº§ç¼“å­˜
- **ç‰ˆæœ¬æ§åˆ¶**: Git

### 1.2 é¡¹ç›®ç»“æ„
```
plzme_v2/
â”œâ”€â”€ app.js                 # åº”ç”¨å…¥å£
â”œâ”€â”€ app.json              # åº”ç”¨é…ç½®
â”œâ”€â”€ app.wxss             # å…¨å±€æ ·å¼
â”œâ”€â”€ pages/               # é¡µé¢ç›®å½•
â”‚   â”œâ”€â”€ index/          # é¦–é¡µ
â”‚   â”œâ”€â”€ chat/           # å¯¹è¯é¡µé¢
â”‚   â”œâ”€â”€ scripts/        # å‰§æœ¬é€‰æ‹©é¡µé¢
â”‚   â””â”€â”€ profile/        # ä¸ªäººä¸­å¿ƒ
â”œâ”€â”€ components/         # è‡ªå®šä¹‰ç»„ä»¶
â”œâ”€â”€ utils/              # å·¥å…·æ¨¡å—
â”‚   â”œâ”€â”€ cache-manager.js      # ç¼“å­˜ç®¡ç†å™¨
â”‚   â”œâ”€â”€ script-manager.js     # å‰§æœ¬ç®¡ç†å™¨(å•ä¾‹)
â”‚   â”œâ”€â”€ ai-request-cache.js   # AIè¯·æ±‚ç¼“å­˜
â”‚   â”œâ”€â”€ storage-manager.js    # å­˜å‚¨ç®¡ç†å™¨
â”‚   â””â”€â”€ deepseek-client.js    # AIå®¢æˆ·ç«¯
â”œâ”€â”€ data/               # æ•°æ®æ–‡ä»¶
â”‚   â””â”€â”€ scripts/        # å‰§æœ¬æ•°æ®
â””â”€â”€ docs/               # æ–‡æ¡£ç›®å½•
```

---

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ•´ä½“æ¶æ„

```
å¾®ä¿¡å°ç¨‹åºå‰ç«¯ â†’ ç¼“å­˜å±‚ â†’ ScriptManagerå•ä¾‹
                    â†“        â†“
              AIè¯·æ±‚ç¼“å­˜ â†’ æœ¬åœ°å­˜å‚¨ â†’ æ•°æ®æŒä¹…åŒ–
                    â†“
               DeepSeek API
```

### 2.2 æ ¸å¿ƒæ¨¡å—æ¶æ„

#### 2.2.1 ç¼“å­˜ç³»ç»Ÿæ¶æ„
```
è¯·æ±‚ â†’ L1ç¼“å­˜(å‘½ä¸­) â†’ è¿”å›æ•°æ®
        â†“(æœªå‘½ä¸­)
     L2ç¼“å­˜(å‘½ä¸­) â†’ æ›´æ–°L1 â†’ è¿”å›æ•°æ®
        â†“(æœªå‘½ä¸­)
     å­˜å‚¨/API â†’ æ›´æ–°ç¼“å­˜ â†’ è¿”å›æ•°æ®
```

#### 2.2.2 ScriptManagerå•ä¾‹æ¨¡å¼
```
å¤šä¸ªé¡µé¢ â†’ ScriptManager.getInstance()
              â†“
         å®ä¾‹å­˜åœ¨? â†’ æ˜¯ â†’ è¿”å›ç°æœ‰å®ä¾‹
              â†“å¦
         åˆ›å»ºæ–°å®ä¾‹ â†’ åˆå§‹åŒ–ç¼“å­˜ â†’ è¿”å›å®ä¾‹
              â†“
         ç»Ÿä¸€æ•°æ®è®¿é—®
```

---

## 3. æ ¸å¿ƒæŠ€æœ¯å®ç°

### 3.1 ç¼“å­˜ç®¡ç†ç³»ç»Ÿ

#### 3.1.1 CacheManager ç±» (`utils/cache-manager.js`)

**è®¾è®¡ç†å¿µ**: å¤šçº§ç¼“å­˜ + LRUæ·˜æ±°ç­–ç•¥

**æ ¸å¿ƒç‰¹æ€§**:
- **L1å†…å­˜ç¼“å­˜**: çƒ­ç‚¹æ•°æ®ï¼Œå¿«é€Ÿè®¿é—®
- **L2ä¼šè¯ç¼“å­˜**: æ¸©æ•°æ®ï¼Œé¡µé¢çº§æŒä¹…åŒ–
- **LRUç®—æ³•**: 50ä¸ªå¯¹è±¡é™åˆ¶ï¼Œè‡ªåŠ¨æ·˜æ±°
- **ç»Ÿè®¡ç›‘æ§**: ç¼“å­˜å‘½ä¸­ç‡ã€æ€§èƒ½ç»Ÿè®¡

**å…³é”®æ–¹æ³•**:
```javascript
// è®¾ç½®ç¼“å­˜(æ”¯æŒè¿‡æœŸæ—¶é—´)
set(key, value, ttl = 3600000)

// è·å–ç¼“å­˜(è‡ªåŠ¨L1/L2åˆ‡æ¢)
get(key)

// æ‰¹é‡æ“ä½œ
setBatch(entries)
getBatch(keys)

// ç¼“å­˜ç»Ÿè®¡
getStats()
```

**ä½¿ç”¨ç¤ºä¾‹**:
```javascript
const cache = require('./utils/cache-manager.js');

// ç¼“å­˜å‰§æœ¬æ•°æ®(1å°æ—¶è¿‡æœŸ)
cache.set('script_romantic', scriptData, 3600000);

// è·å–ç¼“å­˜
const script = cache.get('script_romantic');

// æ‰¹é‡ç¼“å­˜åœºæ™¯æ•°æ®
cache.setBatch([
  ['scene_1', scene1Data],
  ['scene_2', scene2Data]
]);
```

#### 3.1.2 StorageManager ç±» (`utils/storage-manager.js`)

**è®¾è®¡ç†å¿µ**: æ‰¹é‡æ“ä½œ + æ™ºèƒ½å‹ç¼© + è¿‡æœŸç®¡ç†

**æ ¸å¿ƒç‰¹æ€§**:
- **æ‰¹é‡å†™å…¥**: å‡å°‘I/Oæ“ä½œ
- **è‡ªåŠ¨å‹ç¼©**: å¤§æ•°æ®JSONå‹ç¼©
- **è¿‡æœŸæ¸…ç†**: è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®
- **å®¹é‡ç›‘æ§**: å­˜å‚¨ç©ºé—´ç›‘æ§

**å…³é”®æ–¹æ³•**:
```javascript
// æ™ºèƒ½å­˜å‚¨(è‡ªåŠ¨å‹ç¼©)
setItem(key, value, ttl)

// æ™ºèƒ½è¯»å–(è‡ªåŠ¨è§£å‹)
getItem(key)

// æ‰¹é‡æ“ä½œ
setBatch(items)
getBatch(keys)

// æ¸…ç†è¿‡æœŸæ•°æ®
cleanExpired()
```

### 3.2 AIè¯·æ±‚ç¼“å­˜ç³»ç»Ÿ

#### 3.2.1 AIRequestCache ç±» (`utils/ai-request-cache.js`)

**è®¾è®¡ç†å¿µ**: è¯·æ±‚å»é‡ + æ™ºèƒ½ç¼“å­˜ + æ€§èƒ½ä¼˜åŒ–

**æ ¸å¿ƒç‰¹æ€§**:
- **è¯·æ±‚å“ˆå¸Œ**: åŸºäºå†…å®¹çš„è¯·æ±‚å»é‡
- **æ™ºèƒ½ç¼“å­˜**: ç›¸ä¼¼è¯·æ±‚ç»“æœå¤ç”¨
- **æ€§èƒ½ç›‘æ§**: ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡
- **å®¹é‡æ§åˆ¶**: æœ€å¤§100ä¸ªç¼“å­˜é¡¹

**ç¼“å­˜ç­–ç•¥**:
```javascript
// ç”Ÿæˆè¯·æ±‚å”¯ä¸€æ ‡è¯†
generateCacheKey(messages, options) {
    const content = JSON.stringify({ messages, options });
    return this.simpleHash(content);
}

// æ™ºèƒ½ç¼“å­˜åˆ¤æ–­
shouldCache(messages) {
    return messages.length > 2; // åªç¼“å­˜æœ‰ä¸€å®šä¸Šä¸‹æ–‡çš„å¯¹è¯
}
```

#### 3.2.2 DeepSeekClient ä¼˜åŒ– (`utils/deepseek-client.js`)

**ä¼˜åŒ–ç­–ç•¥**:
- **ç¼“å­˜é›†æˆ**: è‡ªåŠ¨ä½¿ç”¨AIè¯·æ±‚ç¼“å­˜
- **é”™è¯¯å¤„ç†**: é™çº§æ–¹æ¡ˆå’Œé‡è¯•æœºåˆ¶
- **æ€§èƒ½ç›‘æ§**: è¯·æ±‚æ—¶é—´å’ŒæˆåŠŸç‡ç»Ÿè®¡

**å…³é”®å®ç°**:
```javascript
async sendMessage(messages, options = {}) {
    // 1. å°è¯•ä»ç¼“å­˜è·å–
    const cached = this.aiCache.get(messages, options);
    if (cached) {
        console.log('ğŸ¯ AIç¼“å­˜å‘½ä¸­');
        return cached;
    }
    
    // 2. å‘é€çœŸå®è¯·æ±‚
    const response = await this.makeRequest(messages, options);
    
    // 3. ç¼“å­˜ç»“æœ
    this.aiCache.set(messages, options, response);
    
    return response;
}
```

### 3.3 ScriptManager å•ä¾‹ä¼˜åŒ–

#### 3.3.1 å•ä¾‹æ¨¡å¼å®ç°

**é—®é¢˜**: å¤šé¡µé¢é‡å¤å®ä¾‹åŒ–ScriptManagerï¼Œé€ æˆå†…å­˜æµªè´¹

**è§£å†³æ–¹æ¡ˆ**: å•ä¾‹æ¨¡å¼ + ç¼“å­˜é›†æˆ

```javascript
class ScriptManager {
    static getInstance() {
        if (!ScriptManager.instance) {
            ScriptManager.instance = new ScriptManager();
        }
        return ScriptManager.instance;
    }
    
    constructor() {
        if (ScriptManager.instance) {
            return ScriptManager.instance;
        }
        
        this.cache = require('./cache-manager.js');
        this.storageManager = require('./storage-manager.js');
        // åˆå§‹åŒ–å…¶ä»–å±æ€§...
    }
}
```

#### 3.3.2 æ•°æ®è®¿é—®ä¼˜åŒ–

**ç¼“å­˜ç­–ç•¥**:
```javascript
// è·å–å‰§æœ¬æ•°æ®(å¸¦ç¼“å­˜)
getScript(scriptId) {
    const cacheKey = `script_${scriptId}`;
    
    // å°è¯•ä»ç¼“å­˜è·å–
    let script = this.cache.get(cacheKey);
    if (script) return script;
    
    // ä»æ–‡ä»¶ç³»ç»ŸåŠ è½½
    script = this.loadScriptFromFile(scriptId);
    
    // ç¼“å­˜1å°æ—¶
    this.cache.set(cacheKey, script, 3600000);
    
    return script;
}

// è·å–åœºæ™¯æ•°æ®(æ‰¹é‡ç¼“å­˜)
getScenes(scriptId) {
    const cacheKey = `scenes_${scriptId}`;
    
    let scenes = this.cache.get(cacheKey);
    if (scenes) return scenes;
    
    // æ‰¹é‡åŠ è½½åœºæ™¯
    scenes = this.loadAllScenes(scriptId);
    
    // ç¼“å­˜åœºæ™¯æ•°æ®
    this.cache.set(cacheKey, scenes, 1800000); // 30åˆ†é’Ÿ
    
    return scenes;
}
```

---

## 4. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 4.1 å·²å®ç°ä¼˜åŒ–

#### 4.1.1 ç¬¬ä¸€é˜¶æ®µä¼˜åŒ–æˆæœ
- **ScriptManagerå•ä¾‹**: å‡å°‘é‡å¤å®ä¾‹åŒ–
- **å¤šçº§ç¼“å­˜**: L1+L2ç¼“å­˜æ¶æ„
- **å†…å­˜ä¼˜åŒ–**: å‡å°‘30-40%å†…å­˜ä½¿ç”¨

#### 4.1.2 ç¬¬äºŒé˜¶æ®µä¼˜åŒ–æˆæœ
- **AIè¯·æ±‚ç¼“å­˜**: æå‡50-80%å“åº”é€Ÿåº¦
- **å­˜å‚¨ä¼˜åŒ–**: å‡å°‘60-70%å­˜å‚¨I/O
- **æ‰¹é‡æ“ä½œ**: æ‰¹é‡è¯»å†™æå‡æ€§èƒ½

### 4.2 æ€§èƒ½ç›‘æ§æŒ‡æ ‡

#### 4.2.1 ç¼“å­˜æ€§èƒ½
```javascript
// è·å–ç¼“å­˜ç»Ÿè®¡
const stats = cache.getStats();
console.log('ç¼“å­˜å‘½ä¸­ç‡:', stats.hitRate);
console.log('L1å‘½ä¸­ç‡:', stats.l1HitRate);
console.log('L2å‘½ä¸­ç‡:', stats.l2HitRate);
```

#### 4.2.2 å­˜å‚¨æ€§èƒ½
```javascript
// å­˜å‚¨å®¹é‡ç›‘æ§
const storageInfo = storageManager.getStorageInfo();
console.log('å·²ä½¿ç”¨:', storageInfo.used);
console.log('å¯ç”¨:', storageInfo.available);
```

### 4.3 ä¼˜åŒ–å»ºè®®

#### 4.3.1 çŸ­æœŸä¼˜åŒ–
1. **å›¾ç‰‡æ‡’åŠ è½½**: å‰§æœ¬å°é¢å›¾ç‰‡æ‡’åŠ è½½
2. **ç»„ä»¶ç¼“å­˜**: é¡µé¢ç»„ä»¶å®ä¾‹å¤ç”¨
3. **è¯·æ±‚åˆå¹¶**: ç›¸å…³APIè¯·æ±‚åˆå¹¶

#### 4.3.2 é•¿æœŸä¼˜åŒ–
1. **CDNé›†æˆ**: é™æ€èµ„æºCDNåŠ é€Ÿ
2. **é¢„åŠ è½½ç­–ç•¥**: æ™ºèƒ½é¢„åŠ è½½ä¸‹ä¸€åœºæ™¯
3. **ç¦»çº¿ç¼“å­˜**: PWAç¦»çº¿èƒ½åŠ›

---

## 5. æ•°æ®å­˜å‚¨è®¾è®¡

### 5.1 å­˜å‚¨ç»“æ„

#### 5.1.1 ç”¨æˆ·å¯¹è¯æ•°æ®
```javascript
// é”®: user_conversation_{scriptId}_{timestamp}
{
    scriptId: 'romantic_script',
    userId: 'wx_user_id',
    scenes: [
        {
            sceneId: 1,
            messages: [
                { role: 'user', content: '...', timestamp: 1234567890 },
                { role: 'assistant', content: '...', timestamp: 1234567891 }
            ],
            choices: [
                { text: 'é€‰æ‹©1', selected: true },
                { text: 'é€‰æ‹©2', selected: false }
            ]
        }
    ],
    currentScene: 1,
    startTime: 1234567890,
    lastUpdate: 1234567900,
    metadata: {
        totalMessages: 15,
        avgResponseTime: 3200,
        specialToolsUsed: ['å†…å¿ƒç‹¬ç™½', 'å…³ç³»åˆ†æ']
    }
}
```

#### 5.1.2 ç¼“å­˜æ•°æ®ç»“æ„
```javascript
// L1å†…å­˜ç¼“å­˜
{
    'script_romantic': {
        data: { /* å‰§æœ¬æ•°æ® */ },
        timestamp: 1234567890,
        ttl: 3600000,
        accessCount: 5
    }
}

// L2ä¼šè¯ç¼“å­˜
{
    'scenes_romantic': {
        data: [ /* åœºæ™¯æ•°ç»„ */ ],
        compressed: true,
        timestamp: 1234567890,
        ttl: 1800000
    }
}
```

### 5.2 æ•°æ®ç”Ÿå‘½å‘¨æœŸ

#### 5.2.1 ç¼“å­˜è¿‡æœŸç­–ç•¥
- **å‰§æœ¬æ•°æ®**: 1å°æ—¶è¿‡æœŸ
- **åœºæ™¯æ•°æ®**: 30åˆ†é’Ÿè¿‡æœŸ  
- **AIå“åº”**: 1å°æ—¶è¿‡æœŸ
- **ç”¨æˆ·ä¼šè¯**: 24å°æ—¶è¿‡æœŸ

#### 5.2.2 æ¸…ç†ç­–ç•¥
```javascript
// åº”ç”¨å¯åŠ¨æ—¶æ¸…ç†
app.onLaunch(() => {
    storageManager.cleanExpired();
    cache.cleanup();
});

// å®šæœŸæ¸…ç†(æ¯10åˆ†é’Ÿ)
setInterval(() => {
    storageManager.cleanExpired();
}, 600000);
```

---

## 6. APIè®¾è®¡ä¸é›†æˆ

### 6.1 DeepSeek APIé›†æˆ

#### 6.1.1 è¯·æ±‚æ ¼å¼
```javascript
{
    model: "deepseek-chat",
    messages: [
        { role: "system", content: "ç³»ç»Ÿæç¤º..." },
        { role: "user", content: "ç”¨æˆ·è¾“å…¥..." }
    ],
    temperature: 0.7,
    max_tokens: 1000,
    stream: false
}
```

#### 6.1.2 å“åº”å¤„ç†
```javascript
// æˆåŠŸå“åº”
{
    id: "chatcmpl-xxx",
    object: "chat.completion",
    model: "deepseek-chat",
    choices: [{
        message: {
            role: "assistant",
            content: "AIå›å¤å†…å®¹"
        },
        finish_reason: "stop"
    }],
    usage: {
        prompt_tokens: 100,
        completion_tokens: 50,
        total_tokens: 150
    }
}
```

#### 6.1.3 é”™è¯¯å¤„ç†
```javascript
// é”™è¯¯é™çº§æ–¹æ¡ˆ
async sendMessage(messages, options = {}) {
    try {
        return await this.makeRequest(messages, options);
    } catch (error) {
        console.error('AIè¯·æ±‚å¤±è´¥:', error);
        
        // è¿”å›é™çº§å“åº”
        return {
            choices: [{
                message: {
                    role: 'assistant',
                    content: this.getFallbackResponse(messages)
                }
            }]
        };
    }
}
```

### 6.2 å†…éƒ¨APIè®¾è®¡

#### 6.2.1 ScriptManager API
```javascript
// è·å–å‰§æœ¬åˆ—è¡¨
getScriptList()

// è·å–ç‰¹å®šå‰§æœ¬
getScript(scriptId)

// è·å–åœºæ™¯æ•°æ®
getScene(scriptId, sceneId)

// ä¿å­˜å¯¹è¯è¿›åº¦
saveProgress(scriptId, progressData)

// è·å–å¯¹è¯å†å²
getConversationHistory(scriptId)
```

#### 6.2.2 ç‰¹æ®Šå·¥å…·API
```javascript
// å†…å¿ƒç‹¬ç™½(30ç§’å†·å´)
async getInnerMonologue(context)

// é«˜èƒ½å¥³ä¸»æ¨¡å¼(5åˆ†é’Ÿé™æ—¶)
async enableHighEnergyMode(duration = 300000)

// å…³ç³»åˆ†ææŠ¥å‘Š(2åˆ†é’Ÿå†·å´)
async generateRelationshipReport(conversationHistory)
```

---

## 7. é”™è¯¯å¤„ç†ä¸ç›‘æ§

### 7.1 é”™è¯¯åˆ†ç±»

#### 7.1.1 ç½‘ç»œé”™è¯¯
- **è¿æ¥è¶…æ—¶**: 5ç§’è¶…æ—¶è®¾ç½®
- **ç½‘ç»œä¸å¯è¾¾**: æç¤ºç”¨æˆ·æ£€æŸ¥ç½‘ç»œ
- **APIé™æµ**: è‡ªåŠ¨é‡è¯•æœºåˆ¶

#### 7.1.2 æ•°æ®é”™è¯¯
- **ç¼“å­˜å¤±æ•ˆ**: è‡ªåŠ¨é‡æ–°åŠ è½½
- **å­˜å‚¨æ»¡**: è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®
- **æ•°æ®æ ¼å¼é”™è¯¯**: é™çº§å¤„ç†

#### 7.1.3 ä¸šåŠ¡é”™è¯¯
- **å‰§æœ¬ä¸å­˜åœ¨**: è¿”å›é»˜è®¤å‰§æœ¬
- **åœºæ™¯è¶Šç•Œ**: è‡ªåŠ¨ä¿®æ­£åœºæ™¯ç´¢å¼•
- **AIå“åº”å¼‚å¸¸**: é™çº§å“åº”

### 7.2 ç›‘æ§ç­–ç•¥

#### 7.2.1 æ€§èƒ½ç›‘æ§
```javascript
// ç›‘æ§å…³é”®æŒ‡æ ‡
const monitor = {
    // ç¼“å­˜å‘½ä¸­ç‡
    trackCacheHit(key, hit) {
        console.log(`ç¼“å­˜${hit ? 'å‘½ä¸­' : 'æœªå‘½ä¸­'}: ${key}`);
    },
    
    // APIå“åº”æ—¶é—´
    trackAPIResponse(duration) {
        console.log(`APIå“åº”æ—¶é—´: ${duration}ms`);
    },
    
    // å­˜å‚¨ä½¿ç”¨æƒ…å†µ
    trackStorageUsage(used, total) {
        console.log(`å­˜å‚¨ä½¿ç”¨: ${used}/${total}`);
    }
};
```

#### 7.2.2 é”™è¯¯ä¸ŠæŠ¥
```javascript
// é”™è¯¯æ”¶é›†
const errorTracker = {
    logError(error, context) {
        const errorInfo = {
            message: error.message,
            stack: error.stack,
            context: context,
            timestamp: Date.now(),
            userAgent: wx.getSystemInfoSync()
        };
        
        // å­˜å‚¨é”™è¯¯æ—¥å¿—
        wx.setStorageSync('error_logs', [
            ...wx.getStorageSync('error_logs') || [],
            errorInfo
        ].slice(-10)); // ä¿ç•™æœ€è¿‘10æ¡
    }
};
```

---

## 8. éƒ¨ç½²ä¸ç»´æŠ¤

### 8.1 éƒ¨ç½²æµç¨‹

#### 8.1.1 å¼€å‘ç¯å¢ƒ
```bash
# 1. å…‹éš†ä»£ç 
git clone [repository-url]

# 2. å®‰è£…å¾®ä¿¡å¼€å‘è€…å·¥å…·
# ä¸‹è½½åœ°å€: https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html

# 3. å¯¼å…¥é¡¹ç›®
# åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­å¯¼å…¥é¡¹ç›®ç›®å½•

# 4. é…ç½®AppID
# åœ¨project.config.jsonä¸­é…ç½®å°ç¨‹åºAppID
```

#### 8.1.2 ç”Ÿäº§ç¯å¢ƒ
```bash
# 1. ä»£ç æ£€æŸ¥
npm run lint

# 2. æ„å»ºä¼˜åŒ–
npm run build

# 3. ä¸Šä¼ ä»£ç 
# ä½¿ç”¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸Šä¼ ä»£ç 

# 4. æäº¤å®¡æ ¸
# åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°æäº¤å®¡æ ¸
```

### 8.2 ç»´æŠ¤æŒ‡å—

#### 8.2.1 æ—¥å¸¸ç»´æŠ¤
1. **ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡**: ç¡®ä¿ > 70%
2. **æ£€æŸ¥å­˜å‚¨ä½¿ç”¨**: é˜²æ­¢å­˜å‚¨æº¢å‡º
3. **ç›‘æ§APIå“åº”**: ç¡®ä¿ < 5ç§’
4. **é”™è¯¯æ—¥å¿—åˆ†æ**: åŠæ—¶ä¿®å¤é—®é¢˜

#### 8.2.2 å®šæœŸç»´æŠ¤
1. **ç¼“å­˜ç­–ç•¥è°ƒä¼˜**: æ ¹æ®ä½¿ç”¨æƒ…å†µè°ƒæ•´TTL
2. **å­˜å‚¨æ¸…ç†**: æ¸…ç†å†—ä½™å’Œè¿‡æœŸæ•°æ®
3. **æ€§èƒ½æµ‹è¯•**: å®šæœŸè¿›è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•
4. **ä»£ç é‡æ„**: ä¼˜åŒ–æ€§èƒ½ç“¶é¢ˆ

#### 8.2.3 ç´§æ€¥å¤„ç†
```javascript
// ç´§æ€¥æ¸…ç†ç¼“å­˜
const emergencyCleanup = () => {
    // æ¸…ç©ºæ‰€æœ‰ç¼“å­˜
    cache.clear();
    
    // æ¸…ç†å­˜å‚¨
    storageManager.clearAll();
    
    // é‡å¯åº”ç”¨
    wx.reLaunch({ url: '/pages/index/index' });
};
```

---

## 9. æµ‹è¯•ç­–ç•¥

### 9.1 å•å…ƒæµ‹è¯•

#### 9.1.1 ç¼“å­˜æ¨¡å—æµ‹è¯•
```javascript
// æµ‹è¯•ç¼“å­˜åŸºæœ¬åŠŸèƒ½
describe('CacheManager', () => {
    test('ç¼“å­˜è®¾ç½®å’Œè·å–', () => {
        cache.set('test_key', 'test_value');
        expect(cache.get('test_key')).toBe('test_value');
    });
    
    test('ç¼“å­˜è¿‡æœŸ', (done) => {
        cache.set('expire_key', 'value', 100); // 100msè¿‡æœŸ
        setTimeout(() => {
            expect(cache.get('expire_key')).toBeNull();
            done();
        }, 150);
    });
});
```

#### 9.1.2 AIç¼“å­˜æµ‹è¯•
```javascript
describe('AIRequestCache', () => {
    test('ç›¸åŒè¯·æ±‚è¿”å›ç¼“å­˜', async () => {
        const messages = [{ role: 'user', content: 'hello' }];
        
        // ç¬¬ä¸€æ¬¡è¯·æ±‚
        await aiCache.set(messages, {}, 'response1');
        
        // ç¬¬äºŒæ¬¡ç›¸åŒè¯·æ±‚åº”è¿”å›ç¼“å­˜
        const cached = aiCache.get(messages, {});
        expect(cached).toBe('response1');
    });
});
```

### 9.2 æ€§èƒ½æµ‹è¯•

#### 9.2.1 ç¼“å­˜æ€§èƒ½æµ‹è¯•
```javascript
// ç¼“å­˜å‘½ä¸­ç‡æµ‹è¯•
const performanceBenchmark = {
    async testCacheHitRate() {
        const requests = 1000;
        let hits = 0;
        
        for (let i = 0; i < requests; i++) {
            const key = `test_${i % 100}`; // æ¨¡æ‹Ÿé‡å¤è¯·æ±‚
            if (cache.get(key)) {
                hits++;
            } else {
                cache.set(key, `value_${i}`);
            }
        }
        
        const hitRate = hits / requests;
        console.log(`ç¼“å­˜å‘½ä¸­ç‡: ${(hitRate * 100).toFixed(2)}%`);
    }
};
```

#### 9.2.2 å­˜å‚¨æ€§èƒ½æµ‹è¯•
```javascript
// å­˜å‚¨I/Oæ€§èƒ½æµ‹è¯•
const storagePerformanceTest = {
    async testBatchOperations() {
        const startTime = Date.now();
        
        // æ‰¹é‡å†™å…¥æµ‹è¯•
        const items = Array.from({ length: 100 }, (_, i) => 
            [`key_${i}`, `value_${i}`]
        );
        
        await storageManager.setBatch(items);
        
        const writeTime = Date.now() - startTime;
        console.log(`æ‰¹é‡å†™å…¥100é¡¹ç”¨æ—¶: ${writeTime}ms`);
        
        // æ‰¹é‡è¯»å–æµ‹è¯•
        const readStart = Date.now();
        const keys = items.map(([key]) => key);
        await storageManager.getBatch(keys);
        
        const readTime = Date.now() - readStart;
        console.log(`æ‰¹é‡è¯»å–100é¡¹ç”¨æ—¶: ${readTime}ms`);
    }
};
```

### 9.3 é›†æˆæµ‹è¯•

#### 9.3.1 ç«¯åˆ°ç«¯æµ‹è¯•
```javascript
// å®Œæ•´å¯¹è¯æµç¨‹æµ‹è¯•
const e2eTest = {
    async testCompleteConversation() {
        const scriptManager = ScriptManager.getInstance();
        
        // 1. åŠ è½½å‰§æœ¬
        const script = scriptManager.getScript('romantic_script');
        expect(script).toBeDefined();
        
        // 2. å¼€å§‹å¯¹è¯
        const scene = scriptManager.getScene('romantic_script', 1);
        expect(scene).toBeDefined();
        
        // 3. AIå“åº”æµ‹è¯•
        const response = await deepseekClient.sendMessage([
            { role: 'user', content: 'ä½ å¥½' }
        ]);
        expect(response.choices[0].message.content).toBeDefined();
        
        // 4. ä¿å­˜è¿›åº¦
        await scriptManager.saveProgress('romantic_script', {
            currentScene: 1,
            messages: [/* ... */]
        });
    }
};
```

---

## 10. å®‰å…¨è€ƒè™‘

### 10.1 æ•°æ®å®‰å…¨

#### 10.1.1 æœ¬åœ°æ•°æ®ä¿æŠ¤
- **æ•æ„Ÿæ•°æ®**: é¿å…å­˜å‚¨ç”¨æˆ·çœŸå®èº«ä»½ä¿¡æ¯
- **æ•°æ®åŠ å¯†**: é‡è¦å¯¹è¯æ•°æ®ç®€å•åŠ å¯†
- **è‡ªåŠ¨æ¸…ç†**: å®šæœŸæ¸…ç†è¿‡æœŸå’Œæ•æ„Ÿæ•°æ®

#### 10.1.2 APIå®‰å…¨
```javascript
// APIè¯·æ±‚å®‰å…¨
const secureRequest = {
    async makeRequest(url, data) {
        // è¯·æ±‚é¢‘ç‡é™åˆ¶
        if (!this.checkRateLimit()) {
            throw new Error('è¯·æ±‚è¿‡äºé¢‘ç¹');
        }
        
        // æ•°æ®éªŒè¯
        if (!this.validateData(data)) {
            throw new Error('è¯·æ±‚æ•°æ®æ— æ•ˆ');
        }
        
        // å‘é€è¯·æ±‚
        return wx.request({
            url,
            data,
            method: 'POST',
            timeout: 5000
        });
    }
};
```

### 10.2 éšç§ä¿æŠ¤

#### 10.2.1 æ•°æ®æœ€å°åŒ–
- åªæ”¶é›†å¿…è¦çš„åŠŸèƒ½æ•°æ®
- ä¸æ”¶é›†ç”¨æˆ·çœŸå®èº«ä»½ä¿¡æ¯
- å¯¹è¯æ•°æ®ä»…æœ¬åœ°å­˜å‚¨

#### 10.2.2 ç”¨æˆ·æ§åˆ¶
```javascript
// ç”¨æˆ·æ•°æ®æ§åˆ¶
const privacyControl = {
    // æ¸…ç©ºç”¨æˆ·æ•°æ®
    clearUserData() {
        const keys = wx.getStorageInfoSync().keys;
        keys.forEach(key => {
            if (key.startsWith('user_')) {
                wx.removeStorageSync(key);
            }
        });
    },
    
    // æ•°æ®å¯¼å‡º
    exportUserData() {
        const userData = {};
        const keys = wx.getStorageInfoSync().keys;
        
        keys.forEach(key => {
            if (key.startsWith('user_')) {
                userData[key] = wx.getStorageSync(key);
            }
        });
        
        return userData;
    }
};
```

---

## 11. æœªæ¥ä¼˜åŒ–æ–¹å‘

### 11.1 æŠ€æœ¯ä¼˜åŒ–

#### 11.1.1 æ¶æ„å‡çº§
- **æ¨¡å—åŒ–é‡æ„**: æ›´ç»†ç²’åº¦çš„æ¨¡å—åˆ’åˆ†
- **TypeScriptè¿ç§»**: ç±»å‹å®‰å…¨å’Œå¼€å‘ä½“éªŒ
- **ç»„ä»¶åŒ–**: æ›´å¤šå¯å¤ç”¨ç»„ä»¶

#### 11.1.2 æ€§èƒ½ä¼˜åŒ–
- **è™šæ‹Ÿæ»šåŠ¨**: é•¿å¯¹è¯åˆ—è¡¨æ€§èƒ½ä¼˜åŒ–
- **å›¾ç‰‡ä¼˜åŒ–**: WebPæ ¼å¼å’Œæ‡’åŠ è½½
- **ä»£ç åˆ†å‰²**: æŒ‰éœ€åŠ è½½é¡µé¢ä»£ç 

#### 11.1.3 æ™ºèƒ½åŒ–æå‡
- **AIå¯¹è¯ä¼˜åŒ–**: æ›´æ™ºèƒ½çš„ä¸Šä¸‹æ–‡ç†è§£
- **ä¸ªæ€§åŒ–æ¨è**: åŸºäºç”¨æˆ·è¡Œä¸ºçš„å‰§æœ¬æ¨è
- **æ™ºèƒ½ç¼“å­˜**: åŸºäºä½¿ç”¨æ¨¡å¼çš„æ™ºèƒ½é¢„ç¼“å­˜

### 11.2 åŠŸèƒ½æ‰©å±•

#### 11.2.1 äº‘ç«¯åŒæ­¥
```javascript
// äº‘ç«¯æ•°æ®åŒæ­¥æ¶æ„
const cloudSync = {
    // ä¸Šä¼ ç”¨æˆ·æ•°æ®
    async uploadUserData(userData) {
        return wx.cloud.callFunction({
            name: 'syncUserData',
            data: { action: 'upload', userData }
        });
    },
    
    // ä¸‹è½½ç”¨æˆ·æ•°æ®
    async downloadUserData(userId) {
        return wx.cloud.callFunction({
            name: 'syncUserData',
            data: { action: 'download', userId }
        });
    }
};
```

#### 11.2.2 é«˜çº§åˆ†æ
- **æƒ…æ„Ÿåˆ†ææŠ¥å‘Š**: æ·±åº¦å¿ƒç†åˆ†æ
- **æˆé•¿è½¨è¿¹**: ç”¨æˆ·æˆé•¿å†ç¨‹å¯è§†åŒ–
- **æ™ºèƒ½å»ºè®®**: ä¸ªæ€§åŒ–æˆé•¿å»ºè®®

---

## 12. é™„å½•

### 12.1 å¸¸ç”¨å‘½ä»¤

#### 12.1.1 å¼€å‘è°ƒè¯•
```javascript
// æ¸…ç†æ‰€æœ‰ç¼“å­˜
cache.clear();

// æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡
console.log(cache.getStats());

// æŸ¥çœ‹å­˜å‚¨ä½¿ç”¨æƒ…å†µ
console.log(storageManager.getStorageInfo());

// é‡ç½®ScriptManagerå®ä¾‹
ScriptManager.instance = null;
```

#### 12.1.2 æ€§èƒ½ç›‘æ§
```javascript
// å¯ç”¨æ€§èƒ½ç›‘æ§
const enablePerformanceMonitoring = () => {
    // ç›‘æ§é¡µé¢åŠ è½½æ—¶é—´
    const performance = wx.getPerformance();
    performance.mark('page-start');
    
    // é¡µé¢åŠ è½½å®Œæˆå
    setTimeout(() => {
        performance.mark('page-end');
        performance.measure('page-load', 'page-start', 'page-end');
        
        const measures = performance.getEntriesByType('measure');
        console.log('é¡µé¢åŠ è½½æ—¶é—´:', measures[0].duration);
    }, 1000);
};
```

### 12.2 æ•…éšœæ’æŸ¥

#### 12.2.1 å¸¸è§é—®é¢˜

**é—®é¢˜1**: ç¼“å­˜å‘½ä¸­ç‡ä½
```javascript
// æ’æŸ¥æ­¥éª¤
1. æ£€æŸ¥ç¼“å­˜é”®æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤TTLè®¾ç½®æ˜¯å¦åˆç†
3. æŸ¥çœ‹ç¼“å­˜å®¹é‡æ˜¯å¦è¶…é™
4. æ£€æŸ¥LRUæ·˜æ±°æ˜¯å¦è¿‡äºé¢‘ç¹

// è°ƒè¯•å‘½ä»¤
console.log('ç¼“å­˜è¯¦æƒ…:', cache.getStats());
console.log('ç¼“å­˜é”®åˆ—è¡¨:', cache.getAllKeys());
```

**é—®é¢˜2**: AIå“åº”ç¼“æ…¢
```javascript
// æ’æŸ¥æ­¥éª¤
1. æ£€æŸ¥ç½‘ç»œè¿æ¥çŠ¶æ€
2. ç¡®è®¤APIè¯·æ±‚ç¼“å­˜æ˜¯å¦ç”Ÿæ•ˆ
3. æŸ¥çœ‹è¯·æ±‚é˜Ÿåˆ—æƒ…å†µ
4. æ£€æŸ¥é™çº§æœºåˆ¶æ˜¯å¦è§¦å‘

// è°ƒè¯•å‘½ä»¤
console.log('AIç¼“å­˜ç»Ÿè®¡:', aiCache.getStats());
console.log('ç½‘ç»œçŠ¶æ€:', wx.getNetworkType());
```

**é—®é¢˜3**: å­˜å‚¨ç©ºé—´ä¸è¶³
```javascript
// æ’æŸ¥æ­¥éª¤
1. æ‰§è¡Œè¿‡æœŸæ•°æ®æ¸…ç†
2. æ£€æŸ¥å¤§å¯¹è±¡å­˜å‚¨æƒ…å†µ
3. ç¡®è®¤å‹ç¼©æœºåˆ¶æ˜¯å¦ç”Ÿæ•ˆ
4. æ¸…ç†ä¸å¿…è¦çš„ç¼“å­˜

// è§£å†³å‘½ä»¤
storageManager.cleanExpired();
storageManager.cleanup();
```

#### 12.2.2 ç´§æ€¥æ¢å¤

```javascript
// ç´§æ€¥é‡ç½®ç³»ç»Ÿ
const emergencyReset = () => {
    try {
        // 1. æ¸…ç©ºæ‰€æœ‰ç¼“å­˜
        cache.clear();
        
        // 2. æ¸…ç©ºå­˜å‚¨
        storageManager.clearAll();
        
        // 3. é‡ç½®å•ä¾‹å®ä¾‹
        ScriptManager.instance = null;
        
        // 4. é‡å¯åº”ç”¨
        wx.reLaunch({ url: '/pages/index/index' });
        
        console.log('âœ… ç³»ç»Ÿé‡ç½®å®Œæˆ');
    } catch (error) {
        console.error('âŒ ç³»ç»Ÿé‡ç½®å¤±è´¥:', error);
    }
};
```

### 12.3 ç‰ˆæœ¬å†å²

#### v2.0 (å½“å‰ç‰ˆæœ¬)
- âœ… å®Œæ•´ç¼“å­˜ç³»ç»Ÿå®ç°
- âœ… ScriptManagerå•ä¾‹æ¨¡å¼
- âœ… AIè¯·æ±‚ç¼“å­˜ä¼˜åŒ–
- âœ… å­˜å‚¨ç®¡ç†å™¨å®ç°
- âœ… æ€§èƒ½ç›‘æ§ä½“ç³»

#### v1.0 (åŸºç¡€ç‰ˆæœ¬)
- âœ… æ ¸å¿ƒå¯¹è¯åŠŸèƒ½
- âœ… åŸºç¡€å‰§æœ¬ç³»ç»Ÿ
- âœ… AIé›†æˆ
- âœ… ç‰¹æ®Šå·¥å…·åŠŸèƒ½

#### æœªæ¥ç‰ˆæœ¬è§„åˆ’
- ğŸ“‹ v2.1: äº‘ç«¯åŒæ­¥åŠŸèƒ½
- ğŸ“‹ v2.2: é«˜çº§åˆ†ææŠ¥å‘Š
- ğŸ“‹ v3.0: ç”¨æˆ·åˆ›ä½œå¹³å°

---

**æ–‡æ¡£ç»´æŠ¤**: æŠ€æœ¯å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2024å¹´12æœˆ  
**ç‰ˆæœ¬**: v2.0  
**è”ç³»**: æŠ€æœ¯è´Ÿè´£äºº 