# DeepSeek API 集成使用指南

## 概述

PlzMe 心理剧本对话系统已集成 DeepSeek API，提供智能化的AI心理导师对话体验。本文档详细说明了如何配置和使用该系统。

## 系统架构

### 核心组件

1. **DeepSeekAPI 类** (`utils/deepseek-api.js`)
   - 负责与 DeepSeek API 的通信
   - 提供提示词生成和管理功能
   - 支持不同模式和工具的调用

2. **ScriptManager 类** (`utils/script-manager.js`)
   - 管理剧本数据和对话流程
   - 提供场景引导和阶段管理
   - 生成个性化报告和建议

3. **聊天页面** (`pages/chat/chat.js`)
   - 集成 AI 对话功能
   - 支持实时交互和工具调用
   - 管理对话历史和用户响应

## 配置指南

### 1. API 密钥配置

在 `app.js` 中配置你的 DeepSeek API 密钥：

```javascript
globalData: {
  // DeepSeek API配置
  deepSeekApiKey: 'sk-your-deepseek-api-key-here', // 填入你的API密钥
  // ... 其他配置
}
```

### 2. API 配置参数

在 `utils/deepseek-api.js` 中可以调整以下参数：

```javascript
const DEEPSEEK_CONFIG = {
  baseURL: 'https://api.deepseek.com/v1/chat/completions',
  model: 'deepseek-chat',
  maxTokens: 2000,
  temperature: 0.8
};
```

## 功能特性

### 1. 智能对话系统

#### 个性化欢迎消息
- 根据剧本内容生成定制化开场白
- 支持高能女主模式的特殊风格
- 自动降级到预设消息（API不可用时）

#### 上下文感知回复
- 基于对话历史生成相关回复
- 根据对话阶段调整引导策略
- 支持情感分析和动态响应

### 2. 剧本引导系统

#### 多阶段对话流程
- **Opening**: 开场引导，建立安全感
- **Exploration**: 深入探索，挖掘核心议题
- **Insight**: 洞察分析，帮助理解
- **Healing**: 疗愈引导，促进成长
- **Empowerment**: 力量激发，建立信心

#### 场景化引导
- 基于剧本的核心场景设计对话
- 针对性的问题和引导策略
- 情感标签匹配和响应

### 3. 心理工具集成

#### 内心独白工具
- AI 引导深度自我对话
- 创造安全的表达空间
- 促进内在声音的倾听

#### 关系报告工具
- 分析人际关系模式
- 提供改善建议
- 识别沟通障碍

#### 自定义剧情工具
- 个性化场景创建
- 角色扮演疗法
- 多角度视角探索

## 使用流程

### 1. 剧本选择与启动

```javascript
// 从剧本详情页跳转到聊天页
wx.navigateTo({
  url: `/pages/chat/chat?type=script&scriptId=001&scriptTitle=未完成的梦&energyMode=false`
});
```

### 2. AI 对话初始化

```javascript
// 系统自动执行以下流程：
1. 加载剧本数据
2. 生成系统提示词
3. 创建个性化欢迎消息
4. 初始化对话历史
```

### 3. 交互式对话

用户输入 → AI 分析 → 生成回复 → 更新对话状态 → 阶段推进

### 4. 报告生成

对话结束后自动生成包含以下内容的成长报告：
- 对话时长和互动统计
- 个人洞察和成长点
- 个性化建议
- 情感分析结果

## 提示词设计

### 1. 系统提示词结构

```
你是PlzMe的专业AI心理导师...

## 剧本背景
[剧本描述]

## 你的角色设定
[AI角色定义]

## 用户角色设定  
[用户角色定义]

## 对话目标
[预期收获列表]

## 对话原则
[引导规则]

## 注意事项
[专业边界]

## ⚡ 高能女主模式特殊指令（可选）
[高能模式规则]
```

### 2. 上下文提示词

根据对话阶段动态生成：
- 当前对话阶段说明
- 引导方向建议
- 建议问题示例

### 3. 工具提示词

针对不同心理工具的专门指令：
- 工具激活指令
- 操作步骤指导
- 预期效果说明

## 降级策略

系统设计了完整的降级机制：

### 1. API 不可用时
- 自动切换到预设回复
- 保持基本对话功能
- 用户无感知降级

### 2. 网络异常时
- 本地缓存机制
- 重试机制
- 错误提示优化

### 3. 数据异常时
- 默认剧本数据
- 标准对话流程
- 基础工具功能

## 开发说明

### 1. 添加新剧本

1. 在 `ScriptManager` 中添加剧本数据：

```javascript
'script_003': {
  id: 'script_003',
  title: '新剧本标题',
  // ... 其他配置
  dialogueGuides: [
    // 对话引导策略
  ]
}
```

2. 添加对应的MD文件到 `assets/scripts_list/`

### 2. 自定义提示词

在 `DeepSeekAPI` 类中修改提示词模板：

```javascript
generateSystemPrompt(scriptData, energyMode) {
  // 自定义提示词逻辑
}
```

### 3. 扩展工具功能

1. 在 `generateToolPrompt` 中添加新工具
2. 在聊天页面添加对应的处理逻辑
3. 更新UI界面

## 性能优化

### 1. API 调用优化
- 合理设置 temperature 和 max_tokens
- 避免过长的对话历史
- 实现请求缓存机制

### 2. 用户体验优化
- 显示打字指示器
- 实现流式回复（可选）
- 优化加载状态

### 3. 错误处理优化
- 详细的错误日志
- 用户友好的错误提示
- 自动重试机制

## 注意事项

### 1. 隐私保护
- 不存储敏感对话内容
- 遵循数据保护规范
- 用户同意机制

### 2. 内容安全
- 实现内容过滤
- 监控异常对话
- 设置安全边界

### 3. 成本控制
- 监控 API 使用量
- 设置合理的限制
- 优化提示词长度

## 测试指南

### 1. 功能测试
- 各种剧本的对话流程
- 工具激活和使用
- 错误场景处理

### 2. 性能测试
- API 响应时间
- 并发用户处理
- 内存使用情况

### 3. 用户体验测试
- 对话自然度
- 引导有效性
- 界面响应性

## 故障排除

### 常见问题

1. **API 调用失败**
   - 检查 API 密钥配置
   - 验证网络连接
   - 查看控制台错误

2. **对话不自然**
   - 调整 temperature 参数
   - 优化提示词
   - 检查上下文管理

3. **工具无法激活**
   - 确认工具配置
   - 检查权限设置
   - 验证数据格式

### 调试技巧

1. 开启详细日志
2. 使用模拟模式测试
3. 检查数据流转
4. 监控API使用情况

---

通过以上配置和使用指南，你可以充分利用 DeepSeek API 为用户提供专业、智能的心理剧本对话体验。系统的设计确保了在各种情况下都能正常运行，为用户提供稳定可靠的服务。 