# utils/prompt_builder.py
def build_script_prompt(title, content, tag, roles_json=None):
    roles_section = f"\n【角色与属性】\n{roles_json}" if roles_json else ""
    return f"""
你是一个心理剧专家及导演，擅长设计可互动的心理剧剧本，帮助用户通过模拟演绎进行自我探索与成长。

以下是一段真实故事，请你基于此生成一个结构化互动心理剧剧本（分为三轮用户选择 + 暗恋对象的内心独白 + 多分支最终关系总结报告）：

【故事标题】{title}
【标签】{tag}
【故事内容】
{content}
{roles_section}

请严格按照以下JSON格式返回剧本结构，确保返回的是合法的JSON字符串：
{{
    "title": "剧本标题",
    "summary": "剧本简介",
    "tags": "剧本标签，多个标签用逗号分隔",
    "roles": [
        {{
            "name": "角色1名称",
            "personality": "角色1性格特点"
        }},
        {{
            "name": "角色2名称",
            "personality": "角色2性格特点"
        }}
    ],
    "scripts": [
        {{
            "scene": "第一轮场景描述",
            "dialogue": [
                "角色A：对话内容",
                "角色B：对话内容"
            ],
            "choices": [
                {{
                    "option": "选项1描述",
                    "reply": "角色对用户选择的即时回复文本",
                    "result": "选择此项的剧情发展"
                }},
                {{
                    "option": "选项2描述",
                    "reply": "角色对用户选择的即时回复文本",
                    "result": "选择此项的剧情发展"
                }},
                {{
                    "option": "选项3描述",
                    "reply": "角色对用户选择的即时回复文本",
                    "result": "选择此项的剧情发展"
                }}
            ]
        }},
        {{
            "scene": "第二轮场景描述",
            "dialogue": [
                "角色A：对话内容",
                "角色B：对话内容"
            ],
            "choices": [
                {{
                    "option": "选项1描述",
                    "reply": "角色对用户选择的即时回复文本",
                    "result": "选择此项的剧情发展"
                }},
                {{
                    "option": "选项2描述",
                    "reply": "角色对用户选择的即时回复文本",
                    "result": "选择此项的剧情发展"
                }},
                {{
                    "option": "选项3描述",
                    "reply": "角色对用户选择的即时回复文本",
                    "result": "选择此项的剧情发展"
                }}
            ]
        }},
        {{
            "scene": "第三轮场景描述",
            "dialogue": [
                "角色A：对话内容",
                "角色B：对话内容"
            ],
            "choices": [
                {{
                    "option": "选项1描述",
                    "reply": "角色对用户选择的即时回复文本",
                    "result": "选择此项的剧情发展"
                }},
                {{
                    "option": "选项2描述",
                    "reply": "角色对用户选择的即时回复文本",
                    "result": "选择此项的剧情发展"
                }},
                {{
                    "option": "选项3描述",
                    "reply": "角色对用户选择的即时回复文本",
                    "result": "选择此项的剧情发展"
                }}
            ]
        }}
    ],
    "inner_monologue": "暗恋对象的第一人称内心独白，使用'我'的视角描述对用户的感受，例如：我其实早就注意到了你...",
    "final_report": {{
        "ABA": "用户依次选择A、B、A时的最终关系总结报告",
        "ACB": "用户依次选择A、C、B时的最终关系总结报告",
        "...": "...可覆盖所有可能的三轮选择路径，每个路径一条总结"
    }}
}}

注意：
1. 请确保生成的是一个合法的JSON字符串
2. 所有字符串值都要用双引号包裹
3. 不要添加任何额外的解释或说明文字
4. 每个场景都必须包含具体的对话内容和3个选择选项，每个选项都要有reply字段
5. 内心独白必须使用暗恋对象的第一人称("我")视角
6. final_report必须为对象类型，key为三轮选择路径（如ABA），value为该路径下的总结
"""